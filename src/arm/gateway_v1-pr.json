{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "applicationName": {
            "type": "string",
            "metadata": {
                "description": "This is the name that will be assigned to the gateway"
            }
        },
        "environmentName": {
            "type": "string"
        },
        "projectCoreRgName": {
            "type": "string"
        },
        "vnetName": {
            "type": "string"
        },
        "subnetName": {
            "type": "string"
        },
        "sslKeyVaultCertSecretId": {
            "type": "string"
        },
        "userAssignedIdentityName": {
            "type": "string"
        },
        // test FQDN
        "projectId": {
            "type": "string",
            "defaultValue": "s141"
        },
        "environmentId": {
            "type": "string",
            "defaultValue": "d01"
        },
        "hostName": {
            "type": "string",
            "metadata": {
                "description": "Web App name"
            }
        },
        "backendHostName1": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        
        "backendHostName2": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "domainSuffix": {
            "type": "string",
            "defaultValue": "education.gov.uk"
        },
        "project": {
            "type": "string",
            "defaultValue": "signin"
        },
        "isProduction": {
            "type": "string",
            "allowedValues": 
            [
            "Yes", 
            "No"
            ],
            "metadata": {
                "description": "Only use 'Yes' for production"
            }
        }
        
        
        

    },
    "functions": [
    ],
    "variables": {
        "baseName": "[tolower(concat(parameters('applicationName'), '-', parameters('environmentName')))]",
        "resourceNames": {
            "applicationGateway": {
                "name": "[concat(variables('baseName'), '-ag')]",
                "hostedServices": {
                    "default": {
                        "backendPoolName": "default-pool",
                        "backendSettingName": "default-backend-setting",
                        "backendSettingProbeName": "default-backend-setting-probe"
                    }
                },
                "sslCertificateName": "gateway-ssl-cert",
                "listenerName": "gateway-ssl-listener",
                "routingRuleName": "gateway-default-ruleset",
                "frontEndPortName": "gateway-frontend-port",
                "frontEndIpConfigurationName": "gateway-frontend-ip-config"
            },
            "publicIpName": "[concat(variables('baseName'), '-pip')]"
        },
        "resourceIds": {
            "userAssignedIdentityId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities/', parameters('userAssignedIdentityName'))]",
            "publicIpResourceId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('resourceNames').publicIpName)]",
            "vnetResourceId": "[resourceId(parameters('projectCoreRgName'), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
            "subnetResourceId": "[resourceId(parameters('projectCoreRgName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]",
            "applicationGateway": {
                "resourceId": "[resourceId('Microsoft.Network/applicationGateways', variables('resourceNames').applicationGateway.name)]",
                "hostedServices": {
                    "default": {
                        "poolResourceId": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('resourceNames').applicationGateway.name), '/backendAddressPools/', variables('resourceNames').applicationGateway.hostedServices.default.backendPoolName)]",
                        "backendSettingResourceId": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('resourceNames').applicationGateway.name), '/backendHttpSettingsCollection/', variables('resourceNames').applicationGateway.hostedServices.default.backendSettingName)]",
                        "probeResourceId": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('resourceNames').applicationGateway.name), '/probes/', variables('resourceNames').applicationGateway.hostedServices.default.backendSettingProbeName)]"
                    }
                }
            }
        },
        "applicationGateway": {
            "name": "[variables('resourceNames').applicationGateway.name]",
            "resourceId": "[variables('resourceIds').applicationGateway.resourceId]",
            "hostedServices": {
                "default": {
                    "poolName": "[variables('resourceNames').applicationGateway.hostedServices.default.backendPoolName]",
                    "pathMap": "/default/*",
                    "backendSetting": {
                        "name": "[variables('resourceNames').applicationGateway.hostedServices.default.backendSettingName]",
                        "port": 443,
                        "protocol": "Https",
                        "requestTimeout": 20,
                        "probe": {
                            "name": "[variables('resourceNames').applicationGateway.hostedServices.default.backendSettingProbeName]",
                            "protocol": "Https",
                            "path": "/"
                        }
                    }
                }
            },
            "backendPool": {
                "name": "[variables('resourceNames').applicationGateway.hostedServices.default.backendPoolName]",
                "resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/backendAddressPools/', variables('resourceNames').applicationGateway.hostedServices.default.backendPoolName)]"
            },
            "backendSetting": {
                "name": "[variables('resourceNames').applicationGateway.hostedServices.default.backendSettingName]",
                "resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/backendHttpSettingsCollection/', variables('resourceNames').applicationGateway.hostedServices.default.backendSettingName)]"
            },
            "sslCertificate": {
                "name": "[variables('resourceNames').applicationGateway.sslCertificateName]",
                "resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/sslCertificates/', variables('resourceNames').applicationGateway.sslCertificateName)]"
            },
            "httpListener": {
                "name": "[variables('resourceNames').applicationGateway.listenerName]",
                "resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/httpListeners/', variables('resourceNames').applicationGateway.listenerName)]"
            },
            //"httpListener2": {
              //  "name": "[variables('resourceNames').applicationGateway.listenerName]",
                //"resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/httpListeners/', variables('resourceNames').applicationGateway.listenerName)]"
            //},
            "routingRule": {
                "name": "[variables('resourceNames').applicationGateway.routingRuleName]",
                "resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/requestRoutingRules/', variables('resourceNames').applicationGateway.routingRuleName)]"
            },
            "frontEndPort": {
                "name": "[variables('resourceNames').applicationGateway.frontEndPortName]",
                "port": 443,
                "resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/frontendPorts/', variables('resourceNames').applicationGateway.frontEndPortName)]"
            },
            "frontEndIpConfiguration": {
                "name": "[variables('resourceNames').applicationGateway.frontEndIpConfigurationName]",
                "resourceId": "[concat(variables('resourceIds').applicationGateway.resourceId, '/frontendIPConfigurations/', variables('resourceNames').applicationGateway.frontEndIpConfigurationName)]"
            }
        }
    },
    "resources": [
          {
            "apiVersion": "2020-04-01",
            "type": "Microsoft.Network/publicIPAddresses",
            "sku": {
                "name": "Standard"
            },
            "name": "[variables('resourceNames').publicIpName]",
            "location": "[resourceGroup().location]",
            "properties": {
                "publicIPAllocationMethod": "Static"
            }
        },
        {
            "apiVersion": "2018-10-01",
            "type": "Microsoft.Network/applicationGateways",
            "name": "[variables('applicationGateway').name]",
            "location": "[resourceGroup().location]",
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "[variables('resourceIds').userAssignedIdentityId]": {}
                }
            },
            "properties": {
                "sku": {
                    "name": "Standard_v2",
                    "tier": "Standard_v2",
                    "capacity": 2
                },
                "gatewayIPConfigurations": [
                    {
                        "name": "gateway-ip-config",
                        "properties": {
                            "subnet": {
                                "id": "[variables('resourceIds').subnetResourceId]"
                            }
                        },
                        "type": "Microsoft.Network/applicationGateways/gatewayIPConfigurations"
                    }
                ],
                "sslCertificates": [
                    {
                        "name": "[variables('applicationGateway').sslCertificate.name]",
                        "properties": {
                            "keyVaultSecretId": "[parameters('sslKeyVaultCertSecretId')]",
                            "httpListeners": [
                                {
                                    "id": "[variables('applicationGateway').httpListener.resourceId]"
                                }
                            ]
                        }
                    }
                ],
                "frontendIPConfigurations": [
                    {
                        "name": "[variables('applicationGateway').frontEndIpConfiguration.name]",
                        "type": "Microsoft.Network/applicationGateways/frontendIPConfigurations",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[variables('resourceIds').publicIpResourceId]"
                            },
                            "httpListeners": [
                                {
                                    "id": "[variables('applicationGateway').httpListener.resourceId]"
                                }
                            ]
                        }
                    }
                ],
                "frontendPorts": [
                    {
                        "name": "[variables('applicationGateway').frontEndPort.name]",
                        "properties": {
                            "port": "[variables('applicationGateway').frontEndPort.port]",
                            "httpListeners": [
                                {
                                    "id": "[variables('applicationGateway').httpListener.resourceId]"
                                }
                            ]
                        },
                        "type": "Microsoft.Network/applicationGateways/frontendPorts"
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "[variables('applicationGateway').hostedServices.default.poolName]",
                        "properties": {
                            "backendAddresses": [],
                            "requestRoutingRules": [
                                {
                                    "id": "[variables('applicationGateway').routingRule.resourceId]"
                                }
                            ]
                        },
                        "type": "Microsoft.Network/applicationGateways/backendAddressPools"
                    },
                     {
                        "name": "oidc-pool",
                        "properties": {
                            "backendAddresses": [
                                //{
                                  //  "fqdn": "s141d01-signin-oidc-1.azurewebsites.net"
                                //},
                                {
                                    "fqdn": "s141d01-signin-oidc-2.azurewebsites.net"
                                },
                                {
                                    "fqdn": "[concat(parameters('projectId'),parameters('environmentId'),'-',parameters('project'),'-',parameters('backendHostName1'),'.azurewebsites.net')]"
                                }
                            ]
                        }
                    },
                    {
                        "name": "interactions-pool",
                        "properties": {
                            "backendAddresses": [
                                {
                                    "fqdn": "s141d01-signin-interactions-1.azurewebsites.net"
                                },
                                {
                                    "fqdn": "s141d01-signin-interactions-2.azurewebsites.net"
                                }
                            ]
                        }
                    }
                ],
                "backendHttpSettingsCollection": [
                    {
                        "name": "[variables('applicationGateway').hostedServices.default.backendSetting.name]",
                        "properties": {
                            "port": "[variables('applicationGateway').hostedServices.default.backendSetting.port]",
                            "protocol": "[variables('applicationGateway').hostedServices.default.backendSetting.protocol]",
                            "cookieBasedAffinity": "Enabled",
                            "connectionDraining": {
                                "enabled": true,
                                "drainTimeoutInSec": 60
                            },
                            "affinityCookieName": "ApplicationGatewayAffinity",
                            "pickHostNameFromBackendAddress": true,
                            "requestTimeout": "[variables('applicationGateway').hostedServices.default.backendSetting.requestTimeout]",
                            "probe": {
                                "id": "[variables('resourceIds').applicationGateway.hostedServices.default.probeResourceId]"
                            },
                            "requestRoutingRules": [
                                {
                                    "id": "[variables('applicationGateway').routingRule.resourceId]"
                                }
                            ]
                          
                        },
                        "type": "Microsoft.Network/applicationGateways/backendHttpSettingsCollection"
                    },
                     {
                        "name": "oidc-backend-setting",
                        "properties": {
                            "port": 443,
                            "protocol": "Https",
                            "cookieBasedAffinity": "Disabled",
                            "connectionDraining": {
                                "enabled": false,
                                "drainTimeoutInSec": 1
                            },
                            "pickHostNameFromBackendAddress": true,
                            "path": "/",
                            "requestTimeout": 30,
                            "probe": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/probes/oidc-backend-setting-probe')]"
                            }
                        }
                    },
                    {
                        "name": "interactions-backend-setting",
                        "properties": {
                            "port": 443,
                            "protocol": "Https",
                            "cookieBasedAffinity": "Disabled",
                            "connectionDraining": {
                                "enabled": false,
                                "drainTimeoutInSec": 1
                            },
                            "pickHostNameFromBackendAddress": true,
                            "path": "/",
                            "requestTimeout": 30,
                            "probe": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/probes/interactions-backend-setting-probe')]"
                            }
                        }
                    }
                ],
                "httpListeners": [
                    {
                        "name": "[variables('applicationGateway').httpListener.name]",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('applicationGateway').frontEndIpConfiguration.resourceId]"
                            },
                            "frontendPort": {
                                "id": "[variables('applicationGateway').frontEndPort.resourceId]"
                            },
                            "protocol": "Https",
                            "requireServerNameIndication": false,
                            "sslCertificate": {
                                "id": "[variables('applicationGateway').sslCertificate.resourceId]"
                            },
                            "requestRoutingRules": [
                                {
                                    "id": "[variables('applicationGateway').routingRule.resourceId]"
                                }
                            ]
                        },
                        "type": "Microsoft.Network/applicationGateways/httpListeners"
                    },
                    {
                        "name": "oidc-ssl-listener",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('applicationGateway').frontEndIpConfiguration.resourceId]"
                            },
                            "frontendPort": {
                                "id": "[variables('applicationGateway').frontEndPort.resourceId]"
                            },
                            "protocol": "Https",
                            "sslCertificate": {
                                "id": "[variables('applicationGateway').sslCertificate.resourceId]"
                            },
                            //"hostName": "dev-oidc.signin.education.gov.uk",
                            //"hostName": "[concat(parameters('environmentName'),'-',parameters('hostName'),'.',parameters('project'),'.',parameters('domainSuffix'))]",
                            "hostName": "[if(equals(parameters('isProduction'),'Yes'), concat(parameters('hostName'),'.',parameters('project'),'.',parameters('domainSuffix')),concat(parameters('environmentName'),'-',parameters('hostName'),'.',parameters('project'),'.',parameters('domainSuffix')))]",
                            "hostNames": [],
                            "requireServerNameIndication": true
                
                        }
                    },
                    {
                        "name": "interactions-ssl-listener",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('applicationGateway').frontEndIpConfiguration.resourceId]"
                            },
                            "frontendPort": {
                                "id": "[variables('applicationGateway').frontEndPort.resourceId]"
                            },
                            "protocol": "Https",
                            "sslCertificate": {
                                "id": "[variables('applicationGateway').sslCertificate.resourceId]"
                            },
                            "hostName": "dev-interactions.signin.education.gov.uk",
                            "hostNames": [],
                            "requireServerNameIndication": true
                        }
                    }
                ],
                "requestRoutingRules": [
                    {
                        "name": "[variables('applicationGateway').routingRule.name]",
                        "properties": {
                            "ruleType": "Basic",
                            "httpListener": {
                                "id": "[variables('applicationGateway').httpListener.resourceId]"
                            },
                            "backendAddressPool": {
                                "id": "[variables('applicationGateway').backendPool.resourceId]"
                            },
                            "backendHttpSettings": {
                                "id": "[variables('applicationGateway').backendSetting.resourceId]"
                            }
                        },
                        "type": "Microsoft.Network/applicationGateways/requestRoutingRules"
                    },
                    {
                        //"name": "oidc-ruleset",
                        "name": "[concat(parameters('hostName'),'-ruleset')]",
                        "properties": {
                            "ruleType": "Basic",
                            "httpListener": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/httpListeners/oidc-ssl-listener')]"
                            },
                            "backendAddressPool": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/backendAddressPools/oidc-pool')]"
                            },
                            "backendHttpSettings": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/backendHttpSettingsCollection/oidc-backend-setting')]"
                            },
                            "rewriteRuleSet": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/rewriteRuleSets/oidc_rewrite')]"
                            }
                        }
                    },
                    {
                        "name": "interactions-ruleset",
                        "properties": {
                            "ruleType": "Basic",
                            "httpListener": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/httpListeners/interactions-ssl-listener')]"
                            },
                            "backendAddressPool": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/backendAddressPools/interactions-pool')]"
                            },
                            "backendHttpSettings": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/backendHttpSettingsCollection/interactions-backend-setting')]"
                            },
                            "rewriteRuleSet": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('applicationGateway').name), '/rewriteRuleSets/interactions_rewrite')]"
                            }
                        }
                    }
                ],
                "urlPathMaps":[],
                "probes": [
                    {
                        "name": "[variables('applicationGateway').hostedServices.default.backendSetting.probe.name]",
                        "properties": {
                            "protocol": "[variables('applicationGateway').hostedServices.default.backendSetting.probe.protocol]",
                            "path": "[variables('applicationGateway').hostedServices.default.backendSetting.probe.path]",
                            "interval": 30,
                            "timeout": 30,
                            "unhealthyThreshold": 3,
                            "pickHostNameFromBackendHttpSettings": true,
                            "minServers": 0,
                            "match": {},
                            "backendHttpSettings": [
                                {
                                    "id": "[variables('resourceIds').applicationGateway.hostedServices.default.backendSettingResourceId]"
                                }
                            ]
                        },
                        "type": "Microsoft.Network/applicationGateways/probes"
                    },
                     {
                        //"name": "oidc-backend-setting-probe",
                        "name": "[concat(parameters('hostName'),'-backend-setting-probe')]",
                        "properties": {
                            "protocol": "Https",
                            "path": "/healthcheck",
                            "interval": 10,
                            "timeout": 5,
                            "unhealthyThreshold": 2,
                            "pickHostNameFromBackendHttpSettings": true,
                            "minServers": 0,
                            "match": {
                                "statusCodes": [
                                    "200-399"
                                ]
                            }
                        }
                    },
                     {
                        "name": "interactions-backend-setting-probe",
                        "properties": {
                            "protocol": "Https",
                            "path": "/healthcheck",
                            "interval": 10,
                            "timeout": 5,
                            "unhealthyThreshold": 2,
                            "pickHostNameFromBackendHttpSettings": true,
                            "minServers": 0,
                            "match": {
                                "statusCodes": [
                                    "200-399"
                                ]
                            }
                        }
                    }
                ],
                "rewriteRuleSets": [
                    {
                        "name": "oidc_rewrite",
                        "properties": {
                            "rewriteRules": [
                                {
                                    "ruleSequence": 100,
                                    "conditions": [],
                                    "name": "AddXForwardedHostHeader",
                                    "actionSet": {
                                        "requestHeaderConfigurations": [
                                            {
                                                "headerName": "X-Forwarded-Host",
                                                "headerValue": "dev-oidc.signin.education.gov.uk"
                                            }
                                        ],
                                        "responseHeaderConfigurations": []
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "name": "interactions_rewrite",
                        "properties": {
                            "rewriteRules": [
                                {
                                    "ruleSequence": 100,
                                    "conditions": [],
                                    "name": "AddXForwardedHostHeader",
                                    "actionSet": {
                                        "requestHeaderConfigurations": [
                                            {
                                                "headerName": "X-Forwarded-Host",
                                                "headerValue": "dev-interactions.signin.education.gov.uk"
                                            }
                                        ],
                                        "responseHeaderConfigurations": []
                                    }
                                }
                            ]
                        }
                    }
                ]
            }
        }
    ],
    "outputs": {
        "resourceName": {
            "type": "string",
            "value": "[variables('applicationGateway').name]"
        },
        "resourceId": {
            "type": "string",
            "value": "[variables('applicationGateway').resourceId]"
        }
    }
}
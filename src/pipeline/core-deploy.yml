parameters:
- name: serviceConnection
  type: string
- name: subscriptionId
  type: string
- name: environmentName
  type: string
- name: applicationName
  type: string
  default: gateway
- name: deploymentLocation
  type: string
  default: 'westeurope'
- name: projectId
  type: string
  default: 's141'
- name: environmentId
  type: string
- name: projectCoreRgSuffix
  type: string
  default: projectcore

jobs:
- deployment: deploy
  displayName: deploy core vnet - ${{parameters.environmentName}}
  environment: ${{parameters.environmentName}}
  pool:
    vmImage: windows-latest
  variables:
  - group: platform-${{parameters.environmentName}}
  - name: overrideParameters
    value: '
    -applicationName "${{parameters.applicationName}}"
    -environmentName "${{parameters.environmentName}}"
    -serviceSubnetPrefix "$(gatewaySubnetPrefix)"
    '
  - name:  serverName
    value: "${{parameters.projectId}}${{parameters.environmentId}}-signin-shd-sql.database.windows.net"
  - name:  databaseName
    value: "${{parameters.projectId}}${{parameters.environmentId}}-signin-organisations-db"
  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: self
        # - task: AzurePowerShell@5
        #   displayName: SQL Server Redirect urls list
        #   inputs:
        #     azureSubscription: ${{parameters.serviceConnection}}
        #     ScriptType: 'InlineScript'
        #     inline: |
        #       Get-ChildItem -Path Env:\ | Format-List
        #       $sqlServerFQDN = $env:SERVERNAME

        #       $databaseName = $env:DATABASENAME

        #       $user = $env:AUDITSQLLOGIN
        #       $pass = $env:AUDITSQLLOGINPASSWORD

        #       $userQuery = "
        #         declare @results varchar(max)

        #         select @results = coalesce(@results + ',', '') +  [redirectUrl]
        #         from [dbo].[serviceRedirectUris]
        #         order by [redirectUrl]

        #         select @results as results
        #       "


        #       $results = Invoke-Sqlcmd -ServerInstance $sqlServerFQDN -Database $databaseName -Username $user -Password $pass  -query $userQuery  -Verbose 
        #       $results = $results -replace '"',''
        #       write-host "##vso[task.setvariable variable=redirectUrls]$results"

        #       write-host $redirectUrls

        #     azurePowerShellVersion: 'LatestVersion'
        - task: replacetokens@5
          displayName: 'Replace tokens'
          inputs:
            rootDirectory: $(System.DefaultWorkingDirectory)/src/pws/
            targetFiles: |
              GetRedirectURL.ps1
            encoding: 'auto'
            tokenPattern: 'rm'
            writeBOM: true
            actionOnMissing: 'fail'
            keepToken: false
            actionOnNoFiles: 'fail'
            enableTransforms: false
            enableRecursion: false
            useLegacyPattern: false
            enableTelemetry: true
        - task: AzurePowerShell@5
          displayName: 'SQL Server Redirect urls list'
          inputs:
            azureSubscription: "${{parameters.ServiceConnection}}"
            ScriptType: 'FilePath'
            ScriptPath: '$(System.DefaultWorkingDirectory)/src/pws/GetRedirectURL.ps1'
            azurePowerShellVersion: 'LatestVersion'
            pwsh: true
        # - template: /Infrastructure/steps/deploy-template.yml@devopsTemplates
        #   parameters:
        #     serviceConnection: ${{parameters.serviceConnection}}
        #     subscriptionId: ${{parameters.subscriptionId}}
        #     resourceGroupName: ${{parameters.projectId}}${{parameters.environmentId}}-${{parameters.projectCoreRgSuffix}}
        #     location: ${{parameters.deploymentLocation}}
        #     templateFilePath: '$(Pipeline.Workspace)/s/src/arm/core.json'
        #     armParameterOverrideString: $(overrideParameters)
        #     processOutputs: false
        #     tags: $(Tags)